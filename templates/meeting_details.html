<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ meeting.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 font-sans min-h-screen p-10">
    <!-- Navbar: Back + Edit + Delete -->
    <nav
      class="flex items-center justify-between mb-6 max-w-3xl mx-auto space-x-2"
    >
      <!-- Back button -->
      <a href="/" class="text-blue-600 inline-flex items-center">
        <i class="bi bi-arrow-left mr-1"></i> Back to Meetings
      </a>

      <div class="flex space-x-2">
        <!-- Read Aloud button -->
        <button
          id="read-aloud-btn"
          class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 flex items-center"
        >
          <i class="bi bi-volume-up mr-1"></i> Read Aloud
        </button>

        <!-- Edit meeting button -->
        <button
          id="edit-meeting-btn"
          class="bg-yellow-500 text-white px-3 py-1.5 rounded-lg hover:bg-yellow-600 flex items-center"
        >
          <i class="bi bi-pencil mr-1"></i> Edit
        </button>

        <!-- Delete meeting button -->
        <button
          id="delete-meeting-btn"
          class="bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700 flex items-center"
        >
          <i class="bi bi-trash mr-1"></i> Delete
        </button>
      </div>
    </nav>

    <div class="bg-white p-8 rounded-2xl shadow-md max-w-3xl mx-auto">
      <!-- Meeting Title & Date -->
      <h1 id="meeting-title" class="text-3xl font-bold text-blue-600 mb-2">
        {{ meeting.title }}
      </h1>
      <p id="meeting-date" class="text-gray-500 mb-6">
        <i class="bi bi-calendar-event mr-1"></i>{{ meeting.date }}
      </p>

      <!-- Transcript -->
      <h2 class="text-xl font-semibold text-gray-700 mb-2">
        <i class="bi bi-file-text mr-1"></i> Transcript
      </h2>
      <div
        id="meeting-transcript"
        class="text-gray-700 whitespace-pre-wrap mb-6"
      >
        {{ meeting.transcript }}
      </div>

      <!-- Summary / Action Items -->
      <h2 class="text-xl font-semibold text-gray-700 mb-2">
        <i class="bi bi-list-check mr-1"></i> Summary / Action Items
      </h2>
      <div id="meeting-summary" class="text-gray-700 whitespace-pre-wrap mb-6">
        {{ meeting.summary }}
      </div>

      <!-- Tasks -->
      {% if tasks %}
      <h2 class="text-xl font-semibold text-gray-700 mb-2">
        <i class="bi bi-person-lines-fill mr-1"></i> Tasks
      </h2>
      <ul class="list-disc list-inside">
        {% for task in tasks %}
        <li><strong>{{ task.person }}:</strong> {{ task.task }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      <!-- Edit buttons (Save/Discard) -->
      <div id="edit-actions" class="mt-6 flex space-x-3 hidden">
        <button
          id="save-edits-btn"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
        >
          Save
        </button>
        <button
          id="discard-edits-btn"
          class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300"
        >
          Discard
        </button>
      </div>
    </div>

    <!-- Delete Meeting Popup -->
    <div
  id="delete-popup"
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-2xl shadow-lg p-6 max-w-sm w-full">
    <h2 class="text-xl font-bold text-red-600 mb-4">
      Delete Meeting
    </h2>
    <p class="text-gray-700 mb-6">
      Are you sure you want to delete this meeting? This action cannot be undone.
    </p>
    <div class="flex justify-end space-x-3">
      <button
        id="delete-cancel"
        class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100"
      >
        Cancel
      </button>
      <button
        id="delete-confirm"
        class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700"
      >
        Delete
      </button>
    </div>
  </div>
</div>

    <!-- Toast -->
    <div
      id="toast"
      class="fixed bottom-5 right-5 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 pointer-events-none transition-all duration-300"
    ></div>

    <script>
      // Delete popup logic
      const deleteBtn = document.getElementById("delete-meeting-btn");
      const deletePopup = document.getElementById("delete-popup");
      const deleteCancel = document.getElementById("delete-cancel");
      const deleteConfirm = document.getElementById("delete-confirm");

      deleteBtn.addEventListener("click", () => {
        deletePopup.classList.remove("hidden");
      });

      deleteCancel.addEventListener("click", () => {
        deletePopup.classList.add("hidden");
      });

      deleteConfirm.addEventListener("click", () => {
        fetch(`/delete_meeting/{{ meeting.id }}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        }).then((r) => {
          if (r.ok) {
            showToast("Meeting deleted successfully!");
            setTimeout(() => {
              window.location.href = "/";
            }, 800);
          } else {
            showToast("Error deleting meeting.");
          }
        });
      });

      // Toast function
      function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.style.opacity = 1;
        setTimeout(() => {
          toast.style.opacity = 0;
        }, 2000);
      }

      // Edit logic
      const editBtn = document.getElementById("edit-meeting-btn");
      const saveBtn = document.getElementById("save-edits-btn");
      const discardBtn = document.getElementById("discard-edits-btn");
      const editActions = document.getElementById("edit-actions");

      const titleEl = document.getElementById("meeting-title");
      const dateEl = document.getElementById("meeting-date");
      const transcriptEl = document.getElementById("meeting-transcript");
      const summaryEl = document.getElementById("meeting-summary");

      let originalData = {};

      editBtn.addEventListener("click", () => {
        // Store original content
        originalData = {
          title: titleEl.textContent,
          date: dateEl.textContent,
          transcript: transcriptEl.textContent,
          summary: summaryEl.textContent,
        };

        // Make fields editable
        titleEl.innerHTML = `<input id="edit-title" class="w-full border border-gray-300 rounded-xl p-2" value="${originalData.title}">`;
        dateEl.innerHTML = `<input id="edit-date" type="date" class="border border-gray-300 rounded-xl p-2" value="${originalData.date}">`;
        transcriptEl.innerHTML = `<textarea id="edit-transcript" class="w-full border border-gray-300 rounded-xl p-2" rows="6">${originalData.transcript}</textarea>`;
        summaryEl.innerHTML = `<textarea id="edit-summary" class="w-full border border-gray-300 rounded-xl p-2" rows="4">${originalData.summary}</textarea>`;

        editActions.classList.remove("hidden");
        editBtn.disabled = true;
      });

      discardBtn.addEventListener("click", () => {
        // Revert to original data
        titleEl.textContent = originalData.title;
        dateEl.innerHTML = `<i class="bi bi-calendar-event mr-1"></i>${originalData.date}`;
        transcriptEl.textContent = originalData.transcript;
        summaryEl.textContent = originalData.summary;

        editActions.classList.add("hidden");
        editBtn.disabled = false;
      });

      // saveBtn.addEventListener("click", () => {
      //   const newTitle = document.getElementById("edit-title").value;
      //   const newDate = document.getElementById("edit-date").value;
      //   const newTranscript = document.getElementById("edit-transcript").value;
      //   const newSummary = document.getElementById("edit-summary").value;

      //   fetch(`/edit_meeting/{{ meeting.id }}`, {
      //     method: "POST",
      //     headers: { "Content-Type": "application/json" },
      //     body: JSON.stringify({
      //       title: newTitle,
      //       date: newDate,
      //       transcript: newTranscript,
      //       summary: newSummary,
      //     }),
      //   }).then((r) => {
      //     if (r.ok) {
      //       showToast("Meeting updated successfully!");
      //       // Update the UI
      //       titleEl.textContent = newTitle;
      //       dateEl.innerHTML = `<i class="bi bi-calendar-event mr-1"></i>${newDate}`;
      //       transcriptEl.textContent = newTranscript;
      //       summaryEl.textContent = newSummary;

      //       editActions.classList.add("hidden");
      //       editBtn.disabled = false;
      //     } else {
      //       showToast("Error updating meeting.");
      //     }
      //   });
      // });


      saveBtn.addEventListener("click", () => {
  const newTitle = document.getElementById("edit-title").value;
  const newDate = document.getElementById("edit-date").value;
  const newTranscript = document.getElementById("edit-transcript").value;
  const newSummary = document.getElementById("edit-summary").value;

  fetch(`/edit_meeting/{{ meeting.id }}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title: newTitle,
      date: newDate,
      transcript: newTranscript,
      summary: newSummary,
    }),
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast("Meeting updated successfully!");
      titleEl.textContent = newTitle;
      dateEl.innerHTML = `<i class="bi bi-calendar-event mr-1"></i>${newDate}`;
      transcriptEl.textContent = newTranscript;
      summaryEl.textContent = newSummary;
      editActions.classList.add("hidden");
      editBtn.disabled = false;
    } else {
      showToast(data.error || "Error updating meeting.");
    }
  })
  .catch(err => {
    console.error(err);
    showToast("Network or server error.");
  });
});


      let isSpeaking = false;
      let utterance;

      const readBtn = document.getElementById("read-aloud-btn");
      const transcriptText =
        document.getElementById("meeting-transcript").textContent +
        ". " +
        document.getElementById("meeting-summary").textContent;

      readBtn.addEventListener("click", () => {
        if (!isSpeaking) {
          // Start speaking
          utterance = new SpeechSynthesisUtterance(transcriptText);
          utterance.rate = 1; // normal speed
          utterance.pitch = 1; // normal pitch
          speechSynthesis.speak(utterance);
          readBtn.innerHTML =
            '<i class="bi bi-volume-mute mr-1"></i> Stop Reading';
          isSpeaking = true;

          // Stop button will also stop on utterance end
          utterance.onend = () => {
            readBtn.innerHTML =
              '<i class="bi bi-volume-up mr-1"></i> Read Aloud';
            isSpeaking = false;
          };
        } else {
          // Stop speaking
          speechSynthesis.cancel();
          readBtn.innerHTML = '<i class="bi bi-volume-up mr-1"></i> Read Aloud';
          isSpeaking = false;
        }
      });
    </script>
  </body>
</html>
